!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var i=e();for(var n in i)("object"==typeof exports?exports:t)[n]=i[n]}}(this,(function(){return function(t){var e={};function i(n){if(e[n])return e[n].exports;var a=e[n]={i:n,l:!1,exports:{}};return t[n].call(a.exports,a,a.exports,i),a.l=!0,a.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)i.d(n,a,function(e){return t[e]}.bind(null,a));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e),i.d(e,"getPicFromGitee",(function(){return c})),i.d(e,"getPICFromTest",(function(){return h})),i.d(e,"Card",(function(){return f})),i.d(e,"configs",(function(){return u}));class n{constructor(t){this.admin=t,this.canvas=this.admin.canvas.getContext("2d")}draw(t,e,i=this.admin.size,n=this.admin.config.style,a){this.admin.canvas.width=i[0],this.admin.canvas.height=i[1];const o=i[0]/n.moldSize[0],s=this.canvas;let r=t;try{e.pic&&s.drawImage(e.pic,n.pic[0]*o,n.pic[1]*o,n.pic[2]*o,n.pic[3]*o)}catch(t){return void console.error(t)}try{e.mold&&(s.drawImage(e.mold,0,0,n.moldSize[0],n.moldSize[1],0,0,i[0],i[1]),s.save())}catch(t){return}try{e.formulaPic&&(s.drawImage(e.formulaPic,n.formula.position[0]*o,n.formula.position[1]*o,n.formula.position[2]*o,n.formula.position[3]*o),s.save())}catch(t){return void console.error(t)}if(r.name){const e="en"===r.lang?"en_name":"cn_simplify";s.save(),s.fillStyle=t.color,s.textBaseline="middle",s.font=n.name.fontSize*o+"px "+e,s.fillText(t.name,n.name.position[0]*o,n.name.position[1]*o,n.name.maxWidth*o)}if(void 0===r.vp&&null===r.vp||(s.save(),s.fillStyle=t.color,s.textBaseline="middle",s.font=26*o+"px en_name",s.fillText("VP: "+r.vp,n.vp[0]*o,n.vp[1]*o,300*o)),void 0===r.dp&&null===r.dp||(s.save(),s.fillStyle=t.color,s.textBaseline="middle",s.font=26*o+"px en_name",s.fillText("DP: "+r.dp,n.dp[0]*o,n.dp[1]*o,300*o)),r.desc){let e=n.desc;const i="en"===r.lang?"en":"cn";let a;a="en"!==t.lang?this.descSplit(t.desc,e.fontSize,i,e.maxLines):this.descSplitEn(t.desc,e.fontSize,i,e.maxLines),console.log(a),s.fillStyle="#000";const l=e.style?e.style+" ":"";s.font=l+e.fontSize*o+"px "+i,"en"!==t.lang?(console.log("中文版"),this.drawDesc(a,e,o)):(console.log("英文版"),this.drawEnDesc(a,e,o))}e.type&&s.drawImage(e.type,n.type[0]*o,n.type[1]*o,n.type[2]*o,n.type[3]*o),this.admin.loaded instanceof Function&&this.admin.loaded(),a instanceof Function&&a()}descSplit(t,e,i,n=6,a=683){if(!t)return[];const o=this.canvas;o.font=e+"px "+i;const s=t.split("\n");for(;s.length>n;){const t=s.pop();s[n-1]+=t}const r=t=>s.reduce((e,i)=>e+=Math.ceil(t*o.measureText(i).width/a),0);let l=1;for(;r(l)>n&&l>0;)l-=.01;let d=[];for(let t of s){const e=l*o.measureText(t).width,i=Math.ceil(e/a),n=Math.max(l*a,e/i);let s=[],r="";for(let e of t)""===r&&s.length>0&&this.isPunctuation(e)?s[s.length-1]+=e:(r+=e,l*o.measureText(r).width>=n&&(s.push(r),r=""));r&&s.push(r),d=d.concat(s)}return d}isPunctuation(t){const e=new RegExp("[\0-ÿ]"),i=new RegExp("[＀-￿]");return e.test(t)||i.test(t)||["。","，","：","【","】","「","」"].includes(t)}descSplitEn(t,e,i,n=6,a=683){if(!t)return[];const o=this.canvas;o.font=e+"px "+i;const s=t.split("\n");for(;s.length>n;){const t=s.pop();s[n-1]+=t}const r=t=>s.reduce((e,i)=>e+=Math.ceil(t*o.measureText(i).width/a),0);let l=1;for(;r(l)>n&&l>0;)l-=.01;let d=[];for(const t of s){const e=l*o.measureText(t).width,i=Math.ceil(e/a),n=Math.max(l*a,e/i),s=[];let r=[];for(const e of t.split(" ")){r.push(e);const t=o.measureText(r.join(" ")).width;l*t>=n&&(l*t-n>o.measureText(" "+e).width/2?(r.pop(),s.push(r),r=[e]):(s.push(r),r=[]))}r.length&&s.push(r),d=d.concat(s)}return d}drawDesc(t,e,i){const n=this.canvas,{maxWidth:a,maxLines:o,lineHeight:s,position:r}=e;for(let e in t){let l=t[e],d=r[0],c=r[1]+e*s;if(e===o-1){n.measureText(l).width<a*i?n.fillText(l,d*i,c*i,n.measureText(l.slice(0,-1)).width):n.fillText(l,d*i,c*i,a*i)}else n.fillText(l,d*i,c*i,a*i)}}drawEnDesc(t,e,i){const n=this.canvas;for(let a in t){let o=t[a],s=e.position[0],r=e.position[1]+a*e.lineHeight;n.fillText(o.join(" "),s*i,r*i,e.maxWidth*i)}}}const a=function({method:t="GET",path:e,data:i,responseType:n}){return new Promise((a,o)=>{let s=new XMLHttpRequest;if(n&&(s.responseType=n),"GET"!==t&&"get"!==t||!i)s.open(t,e,!0),s.send(i);else{let n=[];for(let t in i)n.push(t+"="+i[t]);let a=e+"?"+n.join("&");s.open(t,a,!0),s.send()}s.onreadystatechange=function(){4===s.readyState&&(s.status>=200&&s.status<300||304===s.status?a("blob"===n?s.response:s.responseText):o(new Error("ajax send failed")))}})},o="__MATHMAGICCARDDATA__";class s{constructor(t){if(this.admin=t,window[o]||(window[o]={}),window[o].cardPicCache||(window[o].cardPicCache={}),!window[o].fontMap){let t=document.createElement("div");t.style.width="0",t.style.height="0",t.style.overflow="hidden",document.body.appendChild(t),window[o].fontMap={fontBox:t}}}draw(...t){this.admin.draw(...t)}async loadCardPic(){let t=this.admin.getPic(this.admin.data._id);this.admin.data.pic&&(t=this.admin.data.pic);const e=window[o].cardPicCache;if(e.hasOwnProperty(t)){let i=e[t];i instanceof Promise?await i.then(t=>{this.fileContent.pic=t}):this.fileContent.pic=i}else e[t]=new Promise(i=>{this.getCorsPic(t).then(i=>{this.fileContent.pic=i,e[t]=i}).finally(()=>{i()})}),await e[t];return this.admin.picLoaded(),!0}async loadFormulaPic(){let t=this.admin.getPic(this.admin.data._id);this.admin.data.formulaPic&&(t=this.admin.data.formulaPic);const e=window[o].cardPicCache;if(e.hasOwnProperty(t)){let i=e[t];i instanceof Promise?await i.then(t=>{this.fileContent.formulaPic=t}):this.fileContent.formulaPic=i}else e[t]=new Promise(i=>{this.getCorsPic(t).then(i=>{this.fileContent.formulaPic=i,e[t]=i}).finally(()=>{i()})}),await e[t];return this.admin.picLoaded(),!0}getCorsPic(t){return a({method:"GET",path:t,responseType:"blob"}).then(t=>{let e=URL.createObjectURL(t);return this.download(e)}).catch(t=>console.log(t))}async loadAll(){this.fileContent=await this.getFiles(this.fileList),this.admin.renderState=!0,this.draw(),this.loadCardPic().then(()=>{console.log("图片加载成功"),this.draw()}).catch(t=>{console.info("图片加载失败"),console.error(t)}),this.loadFormulaPic().then(()=>{console.log("公式加载成功"),this.draw()}).catch(t=>{console.info("公式加载成功加载失败"),console.error(t)}),await this.loadFonts(this.admin.config.fonts).then(()=>{setTimeout(()=>{this.draw()},1e3)})}async getFiles(t){let e={};for(let i in t)e[i]=await this.getFile(t[i]);return e}async fileExist(t){return new Promise((e,i)=>{let n=localStorage.getItem(t);if(n){console.log(t,"load localstorage");let a=document.createElement("img");a.src=n,a.setAttribute("crossOrigin","anonymous"),a.onload=function(){e(a)},a.onerror=function(t){i(t)}}else e(!1)})}download(t){return new Promise((e,i)=>{let n=document.createElement("img");n.src=t,n.setAttribute("crossOrigin","anonymous"),n.onload=function(){e(n)},n.onerror=function(t){i(t)}})}async getFile(t,e=!0){let i=await this.fileExist(t);return i||(i=await this.download(t),e&&this.saveImage(t,i)),i}saveImage(t,e){let i=document.createElement("canvas"),n=i.getContext("2d");i.width=e.naturalWidth,i.height=e.naturalHeight,n.drawImage(e,0,0,e.naturalWidth,e.naturalHeight);let a=i.toDataURL("image/png");try{localStorage.setItem(t,a),console.log(t,"successful save the image")}catch(t){console.log("Storage failed: "+t)}}get fileList(){const t=this.admin.moldPath+"/",e=this.admin.data;let i={};i.mold=t+"frame/mold_frame.png";let n=t+"type/value.png";if(e.type){switch(e.type){case"value":break;case"value-assertion":n=t+"value-assertion.png";break;case"assertion":n=t+"assertion.png";break;case"operator":n=t+"operator.png";break;case"operator-value":n=t+"operator-value";break;case"function":n=t+"function";break;case"legend":n=t+"legend.png";break;case"rainbow":n=t+"rainbow.png"}i.type=n}return i}async loadFont(t,e){if(1===window[o].fontMap[e]){var i=document.createElement("style");i.setAttribute("type","text/css"),i.setAttribute("crossOrigin","anonymous"),i.setAttribute("class",e);let n="\n          @font-face {\n            font-family: '"+e+"';\n            src: url('"+t+"');\n          }";i.appendChild(document.createTextNode(n)),document.head.appendChild(i);let s=document.createElement("p");s.innerText="MMC",s.style.fontFamily=e,window[o].fontMap.fontBox.appendChild(s),window[o].fontMap[e]=2;let r=await a({method:"GET",path:t});return window[o].fontMap[e]=3,r}if(2===window[o].fontMap[e]){let i=await a({method:"GET",path:t});return window[o].fontMap[e]=3,i}}loadFonts(t){for(let t in this.admin.config.fonts)window[o].fontMap.hasOwnProperty(t)||(window[o].fontMap[t]=1);let e=[];for(let i in t)if(3!==window[o].fontMap[i]){let n;n="relative"===t[i].type?this.admin.moldPath+"/font/"+t[i].name:t[i].name,this.admin.fontLoaded({type:"font",status:!0,content:i}),e.push(this.loadFont(n,i))}return Promise.all(e).then(()=>{this.admin.fontsLoaded({type:"end"})})}}var r=JSON.stringify({moldSize:[813,1185],pic:[33,33,747,1119],name:{font:"name",fontSize:65,maxWidth:610,position:[92,114]},formula:{font:"name",fontSize:100,maxWidth:710,position:[233,196,347,138]},desc:{font:"desc",position:[92,872,629,185],maxWidth:629,fontSize:24,maxLines:6,lineHeight:26},type:[363,1033,87,87],vp:[92,1084],dp:[475,1084]}),l={moldName:"default",fonts:{en_name:{name:"en_name.ttf",type:"relative"},en:{name:"en.ttf",type:"relative"},cn:{name:"cn.ttf",type:"relative"}},style:Object.assign(JSON.parse(r),{fontMap:{name:"cn",desc:"cn",vp:"en",dp:"en"}})};const d=()=>null,c=t=>`https://ymssx.gitee.io/pics/500/${t}.jpg`,h=t=>`http://localhost:8080/pic/${t}.jpg`;class f{constructor({data:t,canvas:e,size:i,config:n=l,moldPath:a="./mold",getPic:o=h,fontLoaded:s=d,imageLoaded:r=d,fontsLoaded:c=d,imagesLoaded:f=d,picLoaded:u=d,loaded:p=d,autoResize:m=!0,verbose:g=!1}){this.RATE=1185/813,this.data=t,this.config=n,this.key=t._id,this.getPic=o,"/"===a[a.length-1]&&(a=a.substring(0,a.length-1)),this.moldPath=a,this.fontLoaded=s,this.imageLoaded=r,this.fontsLoaded=c,this.imagesLoaded=f,this.picLoaded=u,this.loaded=p,this.verbose=g,this.autoResize=m,this.renderState=!1,this.data=t,this.size=i,e&&this.bind(e,i)}bind(t,e){this.canvas=t;let i=this.getPixelRatio;e?this.size=[e[0]*i,e[1]*i]:this.size?this.size=[this.size[0]*i,this.size[1]*i]:(this.size=this.ansysSize(),this.autoResize&&(this.sizeObserver=new ResizeObserver(()=>{this.resize()}),this.sizeObserver.observe(this.canvas),this.attriObserver=new MutationObserver(()=>{this.resizer&&(clearTimeout(this.resizer),this.resizer=null)}),this.attriObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]}))),this.cardDrawer=new n(this),this.cardFile=new s(this)}rounded(t){let e=.5+t|0;return e=~~(.5+t),e=.5+t<<0,e}render(){this.cardFile.loadAll()}draw(t,e){console.log("test"),this.renderState&&this.cardDrawer.draw(this.data,this.cardFile.fileContent,t,e)}resize(t=500){this.resizer&&clearTimeout(this.resizer),this.resizer=setTimeout(()=>{this._resize_()},t)}_resize_(){this.size=this.ansysSize(),this.draw(this.size)}ansysSize(){let t=this.getPixelRatio,e=t*this.canvas.clientWidth,i=t*this.canvas.clientHeight,n=i/e;return n>this.RATE?i=e*this.RATE:this.RATE>n&&(e=i/this.RATE),e=this.rounded(e),i=this.rounded(i),Math.abs(e-this.canvas.width)/this.canvas.width<=.01||Math.abs(i-this.canvas.height)/this.canvas.height<=.01?[this.canvas.width,this.canvas.height]:[e,i]}get getPixelRatio(){let t=this.canvas.getContext("2d"),e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e}}const u={defualt:l}}])}));