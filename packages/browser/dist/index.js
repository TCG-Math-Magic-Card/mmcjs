!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i=t();for(var n in i)("object"==typeof exports?exports:e)[n]=i[n]}}(this,(function(){return function(e){var t={};function i(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(n,o,function(t){return e[t]}.bind(null,o));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([function(e,t,i){"use strict";i.r(t),i.d(t,"getPicFromGitee",(function(){return d})),i.d(t,"getPICFromTest",(function(){return h})),i.d(t,"Card",(function(){return f})),i.d(t,"configs",(function(){return u}));class n{constructor(e){this.admin=e,this.canvas=this.admin.canvas.getContext("2d")}draw(e,t,i=this.admin.size,n=this.admin.config.style,o){this.admin.canvas.width=i[0],this.admin.canvas.height=i[1];const s=i[0]/n.moldSize[0],a=this.canvas;let r=e;try{t.pic&&a.drawImage(t.pic,n.pic[0]*s,n.pic[1]*s,n.pic[2]*s,n.pic[3]*s)}catch(e){return void console.error(e)}try{t.mold&&(a.drawImage(t.mold,0,0,n.moldSize[0],n.moldSize[1],0,0,i[0],i[1]),a.save())}catch(e){return}try{t.formulaPic&&(a.drawImage(t.formulaPic,n.formula.position[0]*s,n.formula.position[1]*s,n.formula.position[2]*s,n.formula.position[3]*s),a.save())}catch(e){return void console.error(e)}if(r.name){const t="en"===r.lang?"en_name":"cn_simplify";a.save(),a.fillStyle=e.color,a.textBaseline="middle",a.font=n.name.fontSize*s+"px "+t,a.fillText(e.name,n.name.position[0]*s,n.name.position[1]*s,n.name.maxWidth*s)}if(void 0===r.vp&&null===r.vp||(a.save(),a.fillStyle=e.color,a.textBaseline="middle",a.font=26*s+"px en_name",a.fillText("VP: "+r.vp,n.vp[0]*s,n.vp[1]*s,300*s)),void 0===r.dp&&null===r.dp||(a.save(),a.fillStyle=e.color,a.textBaseline="middle",a.font=26*s+"px en_name",a.fillText("DP: "+r.dp,n.dp[0]*s,n.dp[1]*s,300*s)),r.desc){let t=n.desc;const i="en"===r.lang?"en":"cn";let o;o="en"!==e.lang?this.descSplit(e.desc,t.fontSize,i,t.maxLines):this.descSplitEn(e.desc,t.fontSize,i,t.maxLines),console.log(o),a.fillStyle="#000";const l=t.style?t.style+" ":"";a.font=l+t.fontSize*s+"px "+i,"en"!==e.lang?(console.log("中文版"),this.drawDesc(o,t,s)):(console.log("英文版"),this.drawEnDesc(o,t,s))}t.type&&a.drawImage(t.type,n.type[0]*s,n.type[1]*s,n.type[2]*s,n.type[3]*s),this.admin.loaded instanceof Function&&this.admin.loaded(),o instanceof Function&&o()}descSplit(e,t,i,n=6,o=683){if(!e)return[];const s=this.canvas;s.font=t+"px "+i;const a=e.split("\n");for(;a.length>n;){const e=a.pop();a[n-1]+=e}const r=e=>a.reduce((t,i)=>t+=Math.ceil(e*s.measureText(i).width/o),0);let l=1;for(;r(l)>n&&l>0;)l-=.01;let c=[];for(let e of a){const t=l*s.measureText(e).width,i=Math.ceil(t/o),n=Math.max(l*o,t/i);let a=[],r="";for(let t of e)""===r&&a.length>0&&this.isPunctuation(t)?a[a.length-1]+=t:(r+=t,l*s.measureText(r).width>=n&&(a.push(r),r=""));r&&a.push(r),c=c.concat(a)}return c}isPunctuation(e){const t=new RegExp("[\0-ÿ]"),i=new RegExp("[＀-￿]");return t.test(e)||i.test(e)||["。","，","：","【","】","「","」"].includes(e)}descSplitEn(e,t,i,n=6,o=683){if(!e)return[];const s=this.canvas;s.font=t+"px "+i;const a=e.split("\n");for(;a.length>n;){const e=a.pop();a[n-1]+=e}const r=e=>a.reduce((t,i)=>t+=Math.ceil(e*s.measureText(i).width/o),0);let l=1;for(;r(l)>n&&l>0;)l-=.01;let c=[];for(const e of a){const t=l*s.measureText(e).width,i=Math.ceil(t/o),n=Math.max(l*o,t/i),a=[];let r=[];for(const t of e.split(" ")){r.push(t);const e=s.measureText(r.join(" ")).width;l*e>=n&&(l*e-n>s.measureText(" "+t).width/2?(r.pop(),a.push(r),r=[t]):(a.push(r),r=[]))}r.length&&a.push(r),c=c.concat(a)}return c}drawDesc(e,t,i){const n=this.canvas,{maxWidth:o,maxLines:s,lineHeight:a,position:r}=t;for(let t in e){let l=e[t],c=r[0],d=r[1]+t*a;if(t===s-1){n.measureText(l).width<o*i?n.fillText(l,c*i,d*i,n.measureText(l.slice(0,-1)).width):n.fillText(l,c*i,d*i,o*i)}else n.fillText(l,c*i,d*i,o*i)}}drawEnDesc(e,t,i){const n=this.canvas;for(let o in e){let s=e[o],a=t.position[0],r=t.position[1]+o*t.lineHeight;n.fillText(s.join(" "),a*i,r*i,t.maxWidth*i)}}}const o=function({method:e="GET",path:t,data:i,responseType:n}){return new Promise((o,s)=>{let a=new XMLHttpRequest;if(n&&(a.responseType=n),"GET"!==e&&"get"!==e||!i)a.open(e,t,!0),a.send(i);else{let n=[];for(let e in i)n.push(e+"="+i[e]);let o=t+"?"+n.join("&");a.open(e,o,!0),a.send()}a.onreadystatechange=function(){4===a.readyState&&(a.status>=200&&a.status<300||304===a.status?o("blob"===n?a.response:a.responseText):s(new Error("ajax send failed")))}})},s="__MATHMAGICCARDDATA__";class a{constructor(e){if(this.admin=e,window[s]||(window[s]={}),window[s].cardPicCache||(window[s].cardPicCache={}),!window[s].fontMap){let e=document.createElement("div");e.style.width="0",e.style.height="0",e.style.overflow="hidden",document.body.appendChild(e),window[s].fontMap={fontBox:e}}}draw(...e){this.admin.draw(...e)}async loadCardPic(){let e=this.admin.getPic(this.admin.data._id);this.admin.data.pic&&(e=this.admin.data.pic);const t=window[s].cardPicCache;if(t.hasOwnProperty(e)){let i=t[e];i instanceof Promise?await i.then(e=>{this.fileContent.pic=e}):this.fileContent.pic=i}else t[e]=new Promise(i=>{this.getCorsPic(e).then(i=>{this.fileContent.pic=i,t[e]=i}).finally(()=>{i()})}),await t[e];return this.admin.picLoaded(),!0}async loadFormulaPic(){let e=this.admin.getPic(this.admin.data._id);this.admin.data.formulaPic&&(e=this.admin.data.formulaPic);const t=window[s].cardPicCache;if(t.hasOwnProperty(e)){let i=t[e];i instanceof Promise?(console.log("数据来自查询"),this.fileContent.formulaPic=await i):(console.log("数据来自缓存"),this.fileContent.formulaPic=i)}else t[e]=new Promise(i=>{this.getCorsPic(e).then(i=>{console.log("设置查询内容"),this.fileContent.formulaPic=i,t[e]=i}).finally(()=>{i()})}),await t[e];return this.admin.picLoaded(),!0}getCorsPic(e){return o({method:"GET",path:e,responseType:"blob"}).then(e=>{let t=URL.createObjectURL(e);return this.download(t)}).catch(e=>console.log(e))}async loadAll(){this.fileContent=await this.getFiles(this.fileList),this.admin.renderState=!0,this.draw(),this.loadCardPic().then(()=>{console.log("图片加载成功"),this.draw()}).catch(e=>{console.info("图片加载失败"),console.error(e)}),this.loadFormulaPic().then(()=>{console.log("公式加载成功"),this.draw()}).catch(e=>{console.info("公式加载成功加载失败"),console.error(e)}),await this.loadFonts(this.admin.config.fonts).then(()=>{setTimeout(()=>{this.draw()},1e3)})}async getFiles(e){let t={};for(let i in e)t[i]=await this.getFile(e[i]);return t}async fileExist(e){return new Promise((t,i)=>{let n=localStorage.getItem(e);if(n){console.log(e,"load localstorage");let o=document.createElement("img");o.src=n,o.setAttribute("crossOrigin","anonymous"),o.onload=function(){t(o)},o.onerror=function(e){i(e)}}else t(!1)})}download(e){return new Promise((t,i)=>{let n=document.createElement("img");n.src=e,n.setAttribute("crossOrigin","anonymous"),n.onload=function(){console.log("图像加载完成"),t(n)},n.onerror=function(e){i(e)}})}async getFile(e,t=!0){let i=await this.fileExist(e);return i||(i=await this.download(e),t&&this.saveImage(e,i)),i}saveImage(e,t){let i=document.createElement("canvas"),n=i.getContext("2d");i.width=t.naturalWidth,i.height=t.naturalHeight,n.drawImage(t,0,0,t.naturalWidth,t.naturalHeight);let o=i.toDataURL("image/png");try{localStorage.setItem(e,o),console.log(e,"successful save the image")}catch(e){console.log("Storage failed: "+e)}}get fileList(){const e=this.admin.moldPath+"/",t=this.admin.data;let i={};i.mold=e+"frame/mold_frame.png";let n=e+"type/value.png";if(t.type){switch(t.type){case"value":break;case"value-assertion":n=e+"value-assertion.png";break;case"assertion":n=e+"assertion.png";break;case"operator":n=e+"operator.png";break;case"operator-value":n=e+"operator-value";break;case"function":n=e+"function";break;case"legend":n=e+"legend.png";break;case"rainbow":n=e+"rainbow.png"}i.type=n}return i}async loadFont(e,t){if(1===window[s].fontMap[t]){var i=document.createElement("style");i.setAttribute("type","text/css"),i.setAttribute("crossOrigin","anonymous"),i.setAttribute("class",t);let n="\n          @font-face {\n            font-family: '"+t+"';\n            src: url('"+e+"');\n          }";i.appendChild(document.createTextNode(n)),document.head.appendChild(i);let a=document.createElement("p");a.innerText="MMC",a.style.fontFamily=t,window[s].fontMap.fontBox.appendChild(a),window[s].fontMap[t]=2;let r=await o({method:"GET",path:e});return window[s].fontMap[t]=3,r}if(2===window[s].fontMap[t]){let i=await o({method:"GET",path:e});return window[s].fontMap[t]=3,i}}loadFonts(e){for(let e in this.admin.config.fonts)window[s].fontMap.hasOwnProperty(e)||(window[s].fontMap[e]=1);let t=[];for(let i in e)if(3!==window[s].fontMap[i]){let n;n="relative"===e[i].type?this.admin.moldPath+"/font/"+e[i].name:e[i].name,this.admin.fontLoaded({type:"font",status:!0,content:i}),t.push(this.loadFont(n,i))}return Promise.all(t).then(()=>{this.admin.fontsLoaded({type:"end"})})}}var r=JSON.stringify({moldSize:[813,1185],pic:[33,33,747,1119],name:{font:"name",fontSize:65,maxWidth:610,position:[92,114]},formula:{font:"name",fontSize:100,maxWidth:710,position:[233,196,347,138]},desc:{font:"desc",position:[92,872,629,185],maxWidth:629,fontSize:24,maxLines:6,lineHeight:26},type:[363,1033,87,87],vp:[92,1084],dp:[475,1084]}),l={moldName:"default",fonts:{en_name:{name:"en_name.ttf",type:"relative"},en:{name:"en.ttf",type:"relative"},cn:{name:"cn.ttf",type:"relative"}},style:Object.assign(JSON.parse(r),{fontMap:{name:"cn",desc:"cn",vp:"en",dp:"en"}})};const c=()=>null,d=e=>`https://ymssx.gitee.io/pics/500/${e}.jpg`,h=e=>`http://localhost:8080/pic/${e}.jpg`;class f{constructor({data:e,canvas:t,size:i,config:n=l,moldPath:o="./mold",getPic:s=h,fontLoaded:a=c,imageLoaded:r=c,fontsLoaded:d=c,imagesLoaded:f=c,picLoaded:u=c,loaded:p=c,autoResize:m=!0,verbose:g=!1}){this.RATE=1185/813,this.data=e,this.config=n,this.key=e._id,this.getPic=s,"/"===o[o.length-1]&&(o=o.substring(0,o.length-1)),this.moldPath=o,this.fontLoaded=a,this.imageLoaded=r,this.fontsLoaded=d,this.imagesLoaded=f,this.picLoaded=u,this.loaded=p,this.verbose=g,this.autoResize=m,this.renderState=!1,this.data=e,this.size=i,t&&this.bind(t,i)}bind(e,t){this.canvas=e;let i=this.getPixelRatio;t?this.size=[t[0]*i,t[1]*i]:this.size?this.size=[this.size[0]*i,this.size[1]*i]:(this.size=this.ansysSize(),this.autoResize&&(this.sizeObserver=new ResizeObserver(()=>{this.resize()}),this.sizeObserver.observe(this.canvas),this.attriObserver=new MutationObserver(()=>{this.resizer&&(clearTimeout(this.resizer),this.resizer=null)}),this.attriObserver.observe(this.canvas,{attributes:!0,attributeFilter:["width","height"]}))),this.cardDrawer=new n(this),this.cardFile=new a(this)}rounded(e){let t=.5+e|0;return t=~~(.5+e),t=.5+e<<0,t}render(){this.cardFile.loadAll()}draw(e,t){console.log("test"),this.renderState&&this.cardDrawer.draw(this.data,this.cardFile.fileContent,e,t)}resize(e=500){this.resizer&&clearTimeout(this.resizer),this.resizer=setTimeout(()=>{this._resize_()},e)}_resize_(){this.size=this.ansysSize(),this.draw(this.size)}ansysSize(){let e=this.getPixelRatio,t=e*this.canvas.clientWidth,i=e*this.canvas.clientHeight,n=i/t;return n>this.RATE?i=t*this.RATE:this.RATE>n&&(t=i/this.RATE),t=this.rounded(t),i=this.rounded(i),Math.abs(t-this.canvas.width)/this.canvas.width<=.01||Math.abs(i-this.canvas.height)/this.canvas.height<=.01?[this.canvas.width,this.canvas.height]:[t,i]}get getPixelRatio(){let e=this.canvas.getContext("2d"),t=e.backingStorePixelRatio||e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/t}}const u={defualt:l}}])}));